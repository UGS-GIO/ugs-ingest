name: PR Preview & Test

on:
  pull_request:
    branches: [ main ]

env:
  PROJECT_ID: ut-dnr-ugs-backend-tools
  REGION: us-central1
  SERVICE_NAME: ugs-ingest-app

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write
      pull-requests: write  # To post comments

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run linting
      run: npm run lint

    - name: Build project
      run: npm run build

    - name: Test build artifacts
      run: |
        # Check if dist directory was created
        ls -la dist/
        # Check if key files exist
        test -f dist/index.html
        echo "âœ… Build completed successfully"

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
        service_account: ${{ secrets.SERVICE_ACCOUNT }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Build container image (test only)
      run: |
        # Build the image to test Dockerfile validity
        gcloud builds submit --tag $REGION-docker.pkg.dev/$PROJECT_ID/containers/$SERVICE_NAME-pr-${{ github.event.number }} --quiet

    - name: Comment on PR
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'ðŸš€ **Build successful!** \n\nâœ… Lint passed\nâœ… Build completed\nâœ… Container image built\n\nReady for review and merge to deploy to production.'
          })


