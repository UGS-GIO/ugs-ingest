name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger

env:
  PROJECT_ID: ut-dnr-ugs-backend-tools
  SERVICE_NAME: ugs-ingest-app
  REGION: us-central1

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run linting
      run: npm run lint

    - name: Build project
      run: npm run build

    - name: Verify build output
      run: |
        echo "Checking build output..."
        ls -la dist/
        test -f dist/index.html
        test -f server/index.js
        echo "âœ… Build artifacts verified"

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
        service_account: ${{ secrets.SERVICE_ACCOUNT }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Configure Docker
      run: gcloud auth configure-docker $REGION-docker.pkg.dev

    - name: Build and push to Artifact Registry
      run: |
        IMAGE_URL="$REGION-docker.pkg.dev/$PROJECT_ID/containers/$SERVICE_NAME"
        echo "Building image: $IMAGE_URL"
        
        # Use Cloud Build - ignore log streaming issues but check final status
        set +e  # Don't exit on error
        gcloud builds submit --tag $IMAGE_URL --timeout=20m
        BUILD_EXIT_CODE=$?
        
        if [ $BUILD_EXIT_CODE -eq 0 ]; then
          echo "âœ… Build completed successfully"
        else
          echo "âŒ Build may have failed, checking final status..."
          # Get the latest build and check its status
          BUILD_ID=$(gcloud builds list --limit=1 --format="value(id)")
          BUILD_STATUS=$(gcloud builds describe $BUILD_ID --format="value(status)")
          if [ "$BUILD_STATUS" = "SUCCESS" ]; then
            echo "âœ… Build actually succeeded despite exit code"
          else
            echo "âŒ Build failed with status: $BUILD_STATUS"
            exit 1
          fi
        fi

    - name: Deploy to Cloud Run
      run: |
        IMAGE_URL="$REGION-docker.pkg.dev/$PROJECT_ID/containers/$SERVICE_NAME"
        echo "Deploying to Cloud Run..."
        
        gcloud run deploy $SERVICE_NAME \
          --image $IMAGE_URL \
          --platform managed \
          --region $REGION \
          --allow-unauthenticated \
          --port 8080 \
          --memory 512Mi \
          --cpu 1 \
          --max-instances 10 \
          --set-env-vars NODE_ENV=production \
          --timeout 300 \
          --verbosity=info

    - name: Get service URL
      id: url
      run: |
        URL=$(gcloud run services describe $SERVICE_NAME --region=$REGION --format="value(status.url)")
        echo "url=$URL" >> $GITHUB_OUTPUT
        echo "ðŸš€ Deployed to: $URL"

    - name: Test deployment
      run: |
        URL=$(gcloud run services describe $SERVICE_NAME --region=$REGION --format="value(status.url)")
        echo "Testing deployment at: $URL"
        
        # Test health endpoint
        curl -f "$URL/health" || echo "Health check failed"
        
        # Test that the app loads (should get HTML)
        curl -f "$URL/" | head -10 || echo "App load test failed"
        
        echo "âœ… Deployment tests completed"